## Context
經濟模塊是 DRoASMS 的核心功能模塊，包含：
- **服務層**：調整服務、轉帳服務、餘額服務、轉帳事件池、貨幣配置服務
- **Gateway 層**：經濟調整、轉帳、查詢、待處理轉帳、配置的資料庫訪問層

這些模塊包含大量計算邏輯和資料庫操作，是性能優化的重點目標。mypyc 可以將 Python 代碼編譯為 C 擴展，顯著提升執行效率。

## Goals / Non-Goals

### Goals
- 為經濟模塊啟用 mypyc 編譯
- 修復編譯過程中發現的所有型別錯誤和不相容問題
- 驗證編譯後的模塊功能完整性
- 獲得可測量的性能提升（目標 10-30%）

### Non-Goals
- 不改變經濟模塊的 API 或行為
- 不強制要求所有模塊都使用 mypyc（僅限經濟模塊）
- 不改變現有的測試結構或測試方式

## Decisions

### Decision: 僅編譯經濟模塊
**理由**：經濟模塊是性能關鍵路徑，優先編譯可以獲得最大收益。其他模塊（如 bot commands、infra）可能包含更多動態特性，編譯難度較高。

**替代方案**：編譯整個 `src/` 目錄
**不採用原因**：範圍過大，可能引入過多不相容問題，風險較高。

### Decision: 保持向後兼容
**理由**：編譯後的模塊必須能夠與未編譯的模塊無縫協作，確保系統穩定性。

**實作方式**：使用 mypyc 的漸進式編譯策略，僅編譯特定模塊，其他模塊保持 Python 原始碼。

### Decision: 使用 opt_level=3（最高優化）
**理由**：經濟模塊是性能關鍵路徑，應該使用最高級別的優化。

**風險**：可能增加編譯時間和調試難度
**緩解**：在開發環境可以使用較低優化級別，生產環境使用最高級別。

## Risks / Trade-offs

### Risk: 編譯錯誤修復可能改變代碼結構
**緩解**：確保所有修復都通過現有測試驗證，不改變功能行為。

### Risk: 編譯後的模塊可能與某些動態特性不相容
**緩解**：仔細檢查經濟模塊的代碼，避免使用 mypyc 不支援的特性（如 `__getattr__`、動態屬性等）。

### Risk: 性能提升可能不如預期
**緩解**：進行基準測試，如果性能提升不明顯，可以考慮其他優化策略。

### Risk: 編譯流程增加構建複雜度
**緩解**：提供清晰的構建文檔和自動化腳本，確保編譯流程可重複。

## Migration Plan

### Phase 1: 準備與配置
1. 檢查型別註解完整性
2. 配置 mypyc 編譯選項
3. 建立編譯測試環境

### Phase 2: 編譯與修復
1. 嘗試編譯經濟模塊
2. 修復所有編譯錯誤
3. 驗證功能完整性

### Phase 3: 整合與測試
1. 整合到構建流程
2. 執行完整測試套件
3. 進行性能基準測試

### Phase 4: 部署與監控
1. 部署編譯後的模塊
2. 監控性能指標
3. 收集反饋並優化

### Rollback Plan
如果編譯後的模塊出現問題，可以：
1. 快速切換回 Python 原始碼版本
2. 分析問題原因
3. 修復後重新編譯

## Open Questions
- [ ] mypyc 編譯是否會影響現有的依賴注入機制？
- [ ] 編譯後的模塊在 Docker 容器中的表現如何？
- [ ] 是否需要為不同環境（開發、測試、生產）使用不同的編譯選項？
