## Context
整合測試經常因為資源衝突和清理不完整而卡住，影響開發效率和 CI/CD 流程。主要問題包括：
- Docker Compose 容器在多個測試間共享
- 資料庫連線池耗盡
- 非同步協調器未正確停止
- 測試間缺乏隔離

## Goals / Non-Goals
- Goals:
  - 確保每個整合測試使用獨立的資源，避免衝突
  - 確保所有資源在測試結束時正確清理
  - 提供超時保護，防止測試無限等待
  - 提供診斷工具，協助識別資源問題
- Non-Goals:
  - 不改變測試的業務邏輯或驗證內容
  - 不重構測試架構（僅改進資源管理）

## Decisions
- Decision: 使用 Docker Compose 專案名稱隔離
  - 理由：每個測試使用獨立的專案名稱（如 `droasms-test-{test_id}`），避免容器和網路衝突
  - 替代方案：使用臨時目錄或命名空間，但專案名稱更簡單且有效
- Decision: 在 fixture 層級管理資源清理
  - 理由：使用 pytest fixture 的 `finally` 機制確保清理，即使測試失敗也能執行
  - 替代方案：在測試函數中手動清理，但容易遺漏且不統一
- Decision: 使用 pytest-timeout 插件提供超時保護
  - 理由：標準化且易於配置，支援函數級和類別級超時
  - 替代方案：手動實現超時邏輯，但重複且容易出錯

## Risks / Trade-offs
- Risk: 專案名稱過多可能導致 Docker 資源耗盡
  - Mitigation: 確保測試結束時正確清理，並在 CI 中定期清理孤兒專案
- Risk: 超時值設定不當可能導致正常測試被中斷
  - Mitigation: 根據測試類型設定合理的超時值，並在測試日誌中記錄執行時間
- Trade-off: 資源隔離可能增加測試執行時間
  - 接受：測試穩定性比執行速度更重要

## Migration Plan
1. 逐步修改現有測試，添加資源隔離和清理邏輯
2. 保持向後相容，不影響現有測試執行
3. 在 CI 中驗證修改後的測試穩定性
4. 更新文件，說明新的資源管理機制

## Open Questions
- 是否需要為每個測試建立獨立的資料庫實例？（目前使用交易回滾已足夠）
- 是否需要限制並發測試數量？（可透過 pytest-xdist 配置）
