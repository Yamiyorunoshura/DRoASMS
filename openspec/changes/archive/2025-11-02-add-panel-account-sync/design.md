## Context
國務院系統的政府帳戶應在設定領袖時自動建立，但由於以下原因可能出現帳戶缺失：
1. 資料庫遷移過程中配置已建立但帳戶未建立
2. 手動刪除帳戶記錄但配置未清除
3. 並發操作導致的競態條件
4. 系統錯誤導致的不一致狀態

面板開啟時需要查詢政府帳戶餘額，若帳戶不存在會導致功能異常。

## Goals / Non-Goals
- Goals:
  - 確保面板開啟時所有必需的政府帳戶都存在
  - 自動修復配置與帳戶不一致的情況
  - 使用配置中記錄的 account_id 保持一致性
  - 同步經濟系統的實際餘額（如存在）
- Non-Goals:
  - 不改變領袖設定時的帳戶建立邏輯（已存在且運作正常）
  - 不處理配置不存在的情況（應由現有錯誤處理機制處理）
  - 不自動刪除多餘的帳戶（需手動處理或另立變更）

## Decisions

### Decision: 在面板開啟時檢查並建立缺失帳戶
**Rationale**:
- 面板開啟是使用者的主動操作，此時修復資料不一致最為合適
- 不會影響現有的領袖設定流程
- 使用者開啟面板時期望看到正確的資料，此時修復最符合預期

**Alternatives considered**:
- 在領袖設定時強制重建所有帳戶：可能覆寫現有餘額，風險較高
- 背景任務定期檢查：增加系統複雜度，且無法及時修復
- 在每次查詢時檢查：性能開銷過大

### Decision: 使用配置中的 account_id 優先，缺失時使用推導方法
**Rationale**:
- 配置中記錄的 account_id 是權威來源，應優先使用
- 推導方法確保即使配置缺失 account_id 也能建立一致帳戶
- 與現有 `upsert_state_council_config` 邏輯保持一致

**Alternatives considered**:
- 總是使用推導方法：可能與配置不一致，導致多帳戶問題
- 總是使用配置中的 account_id：配置異常時無法恢復

### Decision: 同步經濟系統餘額而非總是設為 0
**Rationale**:
- 經濟系統是單一真實來源，應反映實際餘額
- 避免因帳戶重建導致餘額歸零的資料遺失
- 與現有 `_sync_government_account_balance` 方法一致

**Alternatives considered**:
- 總是設為 0：簡單但可能遺失餘額資料
- 使用 governance 記錄的餘額：可能與經濟系統不一致

### Decision: 檢查所有四個部門帳戶，一次性建立缺失者
**Rationale**:
- 確保系統完整性，避免部分帳戶存在部分缺失的混合狀態
- 一次性操作減少資料庫往返次數
- 簡化錯誤處理邏輯

**Alternatives considered**:
- 僅檢查當前需要的帳戶：可能導致後續操作時才發現缺失
- 分別檢查每個帳戶：增加複雜度和性能開銷

## Risks / Trade-offs

### Risk: 競態條件導致重複建立嘗試
**Mitigation**:
- 使用資料庫的 `ON CONFLICT` 機制，`fn_upsert_government_account` 是冪等的
- 即使多個請求同時建立，最終結果一致
- 不影響現有帳戶的餘額（ON CONFLICT UPDATE 僅更新 balance，不覆寫 account_id）

### Risk: 性能影響
**Mitigation**:
- 檢查操作輕量（單一查詢 fetch_government_accounts）
- 僅在帳戶缺失時才執行建立操作
- 建立操作使用資料庫交易，確保原子性
- 考慮未來可加入快取機制（當前不必要，帳戶變更頻率低）

### Risk: 權限問題
**Mitigation**:
- 帳戶建立是內部操作，不涉及使用者權限檢查
- 面板開啟已通過權限驗證，在此基礎上建立帳戶是安全的
- 建立的帳戶屬於該 guild，不會跨 guild 洩漏

### Risk: 配置異常但帳戶正常的情況
**Mitigation**:
- 檢查邏輯先驗證配置存在（已有現有檢查）
- 配置不存在時直接返回錯誤，不嘗試建立帳戶
- 確保配置是帳戶建立的前提條件

### Risk: 部分帳戶缺失導致面板部分功能異常
**Mitigation**:
- 檢查所有四個部門帳戶，確保完整性
- 建立操作在單一交易中執行，確保原子性
- 建立失敗時記錄錯誤但不影響面板開啟（降級處理）

## Migration Plan
- 無需資料遷移，此變更僅增強現有功能
- 現有配置和帳戶不受影響
- 新邏輯自動修復不一致狀態

## Open Questions
- 是否需要在面板開啟後記錄帳戶建立事件？ → 建議記錄日誌事件以便追蹤
- 帳戶建立失敗時是否應該阻止面板開啟？ → 建議降級處理，允許面板開啟但顯示錯誤訊息
- 是否需要提供手動觸發帳戶同步的指令？ → 當前不必要，面板開啟時自動處理已足夠
