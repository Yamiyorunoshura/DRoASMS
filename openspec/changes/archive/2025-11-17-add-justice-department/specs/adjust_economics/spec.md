# 調整餘額功能擴充 - 支援法務部

## ADDED Requirements

### Requirement: 法務部調整餘額支援
系統SHALL支援法務部作為調整餘額的目標和發起者，並正確處理與法務部相關的餘額調整操作。

#### Scenario: 管理員向法務部調整餘額
- **Given:** 管理員執行 `/adjust` 指令
- **And:** 目標為法務部領導人身份組
- **When:** 指令執行時
- **Then:** 系統SHALL識別為向法務部政府帳戶調整餘額
- **And:** 調整SHALL記錄為政府帳戶調整
- **And:** 法務部帳戶餘額SHALL正確更新

#### Scenario: 法務部調整其他成員餘額
- **Given:** 用戶擁有法務部領導人身份組
- **And:** 用戶執行 `/adjust` 指令
- **When:** 從法務部視角調整其他成員餘額時
- **Then:** 系統SHALL記錄操作者為法務部
- **And:** 調整SHALL遵循管理員調整的權限規則
- **And:** 所有調整SHALL記錄審計原因

### Requirement: 法務部調整權限
系統SHALL為法務部領導人提供調整部門內成員餘額的權限，但限制其調整其他部門餘額的能力。

#### Scenario: 法務部調整部門內成員餘額
- **Given:** 用戶擁有法務部領導人身份組
- **And:** 目標為一般成員（非政府人員）
- **When:** 執行餘額調整時
- **Then:** SHALL允許正數和負數調整
- **And:** SHALL不需要額外管理員權限
- **And:** SHALL記錄詳細的審計資訊

#### Scenario: 法務部嘗試調整其他部門餘額
- **Given:** 用戶擁有法務部領導人身份組
- **And:** 目標為其他政府部門帳戶
- **When:** 嘗試調整時
- **Then:** 系統SHALL拒絕操作
- **And:** SHALL顯示錯誤訊息："法務部無權調整其他部門餘額"

## MODIFIED Requirements

### Requirement: 身份組識別更新
系統SHALL更新現有的身份組識別邏輯，以正確識別法務部領導人身份組並給予相應的調整權限。

#### Scenario: 系統識別操作者身份
- **Given:** 用戶執行 `/adjust` 指令
- **When:** 系統檢查用戶身份組時
- **Then:** SHALL正確識別法務部領導人身份組
- **And:** SHALL根據法務部身份給予相應權限
- **And:** SHALL在審計記錄中正確標記操作來源

### Requirement: 審計日誌增強
系統SHALL增強審計日誌功能，確保法務部的所有調整操作都被明確標記並包含完整的操作資訊。

#### Scenario: 記錄法務部調整操作
- **Given:** 法務部執行餘額調整
- **When:** 系統記錄審計日誌時
- **Then:** SHALL明確標記操作者為"法務部"
- **And:** SHALL包含調整原因和時間戳
- **And:** SHALL記錄調整前後的餘額變化

### Requirement: 無權限錯誤處理
系統SHALL更新無權限錯誤處理，為不同類型的用戶提供清晰的權限說明。

#### Scenario: 無權限用戶嘗試調整
- **Given:** 用戶沒有管理員權限也不是法務部領導人
- **When:** 嘗試執行 `/adjust` 指令時
- **Then:** 系統SHALL拒絕操作
- **And:** SHALL顯示錯誤訊息："您沒有權限執行餘額調整"

### Requirement: 無效目標錯誤處理
系統SHALL更新無效目標錯誤處理，為用戶提供清晰的支援目標列表和權限範圍說明。

#### Scenario: 調整到無效目標
- **Given:** 用戶嘗試調整到不支援的目標類型
- **When:** 系統驗證目標時
- **Then:** SHALL提供清晰的支援目標列表
- **And:** SHALL說明法務部的調整權限範圍

## 技術實現要點

### 1. 修改文件
- `/src/bot/commands/adjust.py` - 更新身份組檢查邏輯
- `/src/bot/services/adjustment_service.py` - 添加法務部特殊處理
- `/src/services/permission_service.py` - 更新權限檢查

### 2. 權限矩陣
```
操作者身份 \ 目標身份 | 一般成員 | 法務部 | 其他部門 | 管理員
------------------|----------|--------|----------|--------
法務部領導人      | ✅ 允許   | ❌ 拒絕 | ❌ 拒絕   | ❌ 拒絕
管理員           | ✅ 允許   | ✅ 允許 | ✅ 允許   | ✅ 允許
```

## 特殊考量

### 1. 審計要求
- 所有法務部調整操作必須提供明確原因
- 原因必須與司法職能相關（如罰款、賠償等）

### 2. 權限邊界
- 法務部只能調整非政府人員的餘額
- 不能調整其他部門或高層人員的餘額

## 跨能力依賴
- 依賴 `justice_department_panel` 提供操作界面
- 與 `transfer_economics` 共享身份組配置
- 使用核心經濟系統的審計機制
- 依賴權限服務進行身份驗證
