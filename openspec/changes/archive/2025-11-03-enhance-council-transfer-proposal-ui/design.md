## Context
目前理事會轉帳提案僅支援轉帳給使用者（`target_id` 為使用者 ID），使用 Modal 文字輸入來指定受款人。國務院面板已有部門轉帳功能，但理事會面板尚未支援轉帳給政府部門。同時，政府部門的識別方式（名稱、代碼、帳戶 ID 推導）散落在多處代碼中，缺乏統一格式。

## Goals / Non-Goals
### Goals
- 提供互動式面板讓理事選擇轉帳類型（部門/使用者）與收款人
- 建立統一的部門識別格式，支援動態載入與擴展
- 保持向後相容，現有提案與資料庫結構不受影響
- 維持理事會與國務院系統的一致性

### Non-Goals
- 不改變現有提案的投票、執行與撤案流程
- 不改變部門帳戶 ID 推導演算法（保持相容性）
- 不強制遷移既有硬編碼的部門列表（允許漸進式遷移）

## Decisions

### Decision: 部門識別格式採用 JSON Schema
**What**: 定義部門 JSON 格式，包含：
- `id`: 唯一識別碼（字串，如 "interior_affairs"）
- `name`: 顯示名稱（如 "內政部"）
- `code`: 數值代碼（用於帳戶 ID 推導，如 1）
- `emoji`: 可選表情符號（如 "🏘️"）

**Why**:
- JSON 格式易於擴展與維護
- 可從設定檔或資料庫載入，支援動態新增
- 保持與現有代碼結構相容（可映射回字串名稱）

**Alternatives considered**:
- 純資料庫表：過於重量級，部門列表變化不頻繁
- Enum 類型：仍需硬編碼，無法動態擴展

### Decision: 面板採用兩階段選擇流程
**What**:
1. 第一階段：選擇轉帳類型（按鈕：轉帳給政府部門 / 轉帳給使用者）
2. 第二階段：根據類型顯示對應的下拉選單
   - 部門類型：顯示可用部門列表
   - 使用者類型：顯示使用者選擇器（可能需要搜尋或分頁）

**Why**:
- 降低 UI 複雜度，避免單一下拉選單過長
- 明確區分兩種類型，減少錯誤選擇
- 與國務院面板的轉帳流程一致

**Alternatives considered**:
- 單一下拉選單包含所有選項：會變得過長，且混合部門與使用者不利於分類
- 保持 Modal 但加入下拉選單：仍不如面板互動流暢

### Decision: 資料庫擴充使用可選欄位
**What**: 在 `governance.proposals` 表新增 `target_department_id` 欄位（可為 NULL），與現有 `target_id` 互斥或共存。

**Why**:
- 保持向後相容，現有提案不受影響
- 允許未來同時支援混合類型（如果需要）
- 遷移成本低，現有查詢邏輯僅需微調

**Alternatives considered**:
- 使用單一 `target_type` + `target_id`：需要統一識別碼格式，可能與現有使用者 ID 衝突
- 分離表：過於複雜，違反簡化原則

### Decision: 部門定義載入採用配置檔案 + 記憶體快取
**What**: 在專案根目錄或 `src/` 下建立 `departments.json`，應用啟動時載入並快取於服務層。

**Why**:
- 無需資料庫查詢，效能較佳
- 版本控制友善，變更可追蹤
- 簡單直接，符合「無需求不複雜化」原則

**Alternatives considered**:
- 資料庫表：需要遷移，且部門變更不頻繁
- 環境變數：不適合結構化資料

## Risks / Trade-offs

### Risk: 部門列表不一致
**Mitigation**:
- 建立單一來源的部門定義（JSON）
- 在服務層提供統一的查詢介面
- 資料庫約束仍保留，作為最後防線

### Risk: 使用者下拉選單效能
**Mitigation**:
- 限制顯示數量（如最多 25 個，使用 Discord Select 限制）
- 如需搜尋，提供文字輸入過濾或分頁
- 或考慮使用 Discord 的 User Select 元件（Discord.py 2.x 支援）

### Risk: 現有硬編碼未完全遷移
**Mitigation**:
- 允許漸進式遷移，保留現有字串列表作為後備
- 提供輔助函式從 JSON 映射回字串名稱
- 在測試中驗證兩種路徑的一致性

## Migration Plan

### Phase 1: 建立部門定義格式
1. 建立 `src/config/departments.json`
2. 實作部門載入與快取邏輯
3. 更新服務層以使用統一格式（保留字串映射）

### Phase 2: 擴充資料庫結構
1. 新增 `target_department_id` 欄位（可為 NULL）
2. 更新 `fn_create_proposal` 支援部門目標
3. 更新相關查詢與匯出邏輯

### Phase 3: UI 實作
1. 建立轉帳類型選擇 View
2. 實作部門下拉選單與使用者選擇器
3. 整合至理事會面板
4. 移除或標記為 deprecated 舊的 Modal 輸入

### Phase 4: 測試與驗證
1. 單元測試：部門載入、提案建立（部門/使用者）
2. 整合測試：面板互動流程
3. 契約測試：確保向後相容

## Open Questions
- 使用者選擇器是否需要搜尋功能？或僅顯示前 N 名成員？
- 部門定義是否需要支援多語言顯示名稱？
- 是否需要在面板中顯示部門餘額（類似國務院面板）？
