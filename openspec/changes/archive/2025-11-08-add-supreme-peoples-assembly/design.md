# Design: 最高人民會議系統

## Context
最高人民會議是繼理事會和國務院之後的第三個治理系統，需要與現有系統整合並保持一致的使用者體驗。系統需要支援：
- 獨立的帳戶系統（類似理事會帳戶）
- 轉帳功能（與使用者、理事會、政府部門、常任理事會）
- 表決機制（不同於理事會的投票機制，投票後不可改選）
- 傳召功能（通知機制）

## Goals / Non-Goals

### Goals
- 提供與理事會和國務院一致的治理體驗
- 支援議長和議員身分組的配置和管理
- 實現匿名投票機制，投票後不可改選
- 支援傳召功能，可傳召議員或政府官員
- 與現有經濟系統無縫整合

### Non-Goals
- 不改變現有理事會或國務院的運作方式
- 不實現複雜的議事規則（如議程管理、委員會等）
- 不實現自動化決策執行（表決結果需手動執行）

## Decisions

### Decision: 帳戶 ID 生成策略
**決定**：使用 deterministic 方法生成最高人民會議帳戶 ID，使用 9.2e15 區段作為基底，避免與理事會帳戶（9e15）、國務院主帳戶（9.1e15）和部門帳戶（9.5e15）碰撞。

**公式**：`9_200_000_000_000_000 + guild_id`

**替代方案考慮**：
- 使用隨機 UUID：需要額外的映射表，增加複雜度
- 使用現有帳戶：會與其他系統混淆

### Decision: 表決機制設計
**決定**：採用「投票後不可改選」的機制，與理事會的「可改票」機制區分。

**理由**：
- 提高決策的嚴肅性和不可逆性
- 簡化計票邏輯（無需追蹤改票歷史）
- 符合「最高人民會議」的權威性定位

**替代方案考慮**：
- 允許改票：與理事會功能重複，缺乏差異化
- 允許撤回投票：增加複雜度，且可能被濫用

### Decision: 匿名投票實現
**決定**：投票過程中僅顯示合計票數，表決結束後揭露各投票者的投票結果。

**理由**：
- 保護投票者隱私，避免同儕壓力
- 結案後揭露確保可追溯性和問責制
- 與理事會系統保持一致

### Decision: 傳召功能實現
**決定**：使用 Discord DM 通知被傳召人，並在面板中顯示傳召記錄。

**理由**：
- DM 通知確保被傳召人能夠收到通知
- 面板記錄提供可追溯性
- 簡單直接，無需額外的通知系統

**替代方案考慮**：
- 使用公開頻道通知：可能造成頻道混亂
- 使用 webhook：增加複雜度，且需要額外配置

### Decision: 政府架構識別
**決定**：使用現有的 JSON 政府架構（`departments.json`）來識別政府部門和常任理事會。

**理由**：
- 重用現有架構，保持一致性
- 無需額外的配置系統
- 與國務院面板的實現保持一致

## Risks / Trade-offs

### Risk: 帳戶 ID 碰撞
**風險**：如果未來需要更多治理系統，可能發生 ID 碰撞。

**緩解**：預留足夠的 ID 區段空間，並在文檔中明確記錄各系統的 ID 範圍。

### Risk: 投票後不可改選可能導致錯誤決策
**風險**：如果投票者誤投，無法修正。

**緩解**：
- 在投票前提供確認機制
- 允許議長在特定條件下撤銷表決（如技術錯誤）
- 提供清晰的投票說明

### Risk: 傳召功能可能被濫用
**風險**：議長可能頻繁傳召，造成騷擾。

**緩解**：
- 記錄傳召歷史，供管理員審查
- 考慮未來加入頻率限制（不在 MVP 範圍內）

## Migration Plan

### 階段 1：資料庫遷移
1. 建立 `supreme_assembly_configurations` 表
2. 建立 `supreme_assembly_accounts` 表
3. 建立 `supreme_assembly_proposals` 表（表決）
4. 建立 `supreme_assembly_votes` 表
5. 建立 `supreme_assembly_summons` 表（傳召記錄）

### 階段 2：服務層實現
1. 實現 `SupremeAssemblyService`
2. 實現 `SupremeAssemblyGateway`
3. 擴展 `AdjustmentService` 和 `TransferService` 支援議長身分組

### 階段 3：指令和面板
1. 實現 `/supreme_assembly` 指令群組
2. 實現面板 UI 和互動邏輯
3. 實現表決和投票機制
4. 實現傳召功能

### 階段 4：整合測試
1. 測試與現有系統的整合
2. 測試權限控制
3. 測試轉帳功能
4. 測試表決和投票機制

## Open Questions
- 表決是否需要設定截止時間？如果需要，預設時長是多少？
- 傳召功能是否需要被傳召人的確認機制？
- 是否需要支援表決結果的自動執行（類似理事會提案）？
