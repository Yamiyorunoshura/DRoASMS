# Design: Result<T,E> 錯誤處理機制

## Context
DRoASMS 目前使用傳統 Python 異常處理，在生產環境中面臨挑戰。機器人系統需要穩定、可靠的錯誤處理機制，特別是在 Discord API 互動、資料庫操作和經濟系統交易中。

### 約束條件
- 必須相容現有的 discord.py 框架
- 不能破壞現有的依賴注入容器
- 必須支援 async/await 模式
- 必須與現有的 structlog 日誌系統集成
- 必須通過現有的 mypy 嚴格模式型別檢查

## Goals / Non-Goals
- **Goals**:
  - 提供類型安全的錯誤處理
  - 減少未捕獲異常導致的機器人崩潰
  - 改善錯誤調試和監控能力
  - 支援鏈式錯誤處理操作
  - 保持與現有程式碼的相容性

- **Non-Goals**:
  - 完全取代 Python 異常機制（在特定情況下仍會使用）
  - 改變 discord.py 的核心錯誤處理行為
  - 實現 Rust 的所有 Result 功能（專注於最常用的 subset）

## Decisions

### 1. Result 類型設計
**Decision**: 使用 dataclass 實現 Ok(T) 和 Err(E) 包裝類型，提供類似 Rust 的語義
**替代方案考慮**:
- 繼承自 Union[Ok, Err]: 過於複雜，難以實現
- 使用 NamedTuple: 不支援方法，擴展性差
- 直接使用泛型 Result[T, E]: 失去類型區分能力

### 2. 錯誤類型層次結構
**Decision**: 建立分層錯誤類型系統：基礎 Error 類型，派生出 DatabaseError, DiscordError, ValidationError 等
**替代方案考慮**:
- 使用字串錯誤訊息: 失去類型安全
- 使用現有 Python Exception: 違背 Result 設計原則

### 3. 非同步支援
**Decision**: 實現 AsyncResult[T, E] 類型，支援 await 操作和異步鏈式調用
**替代方案考慮**:
- 在同步 Result 中包裝 Future: 過於複雜
- 不支援異步: 不符合項目 async/await 模式

### 4. 日誌集成
**Decision**: Result 物件自動記錄錯誤到 structlog，包含上下文資訊
**替代方案考慮**:
- 手動日誌記錄: 容易遺漏，不一致
- 不集成日誌: 失去可觀測性

## Risks / Trade-offs

- **學習成本**: 開發團隊需要熟悉新的錯誤處理模式
  - **緩解**: 提供遷移工具、文件和範例程式碼
- **效能影響**:額外的包裝層可能有輕微效能開銷
  - **緩解**: 實現高效的內部機制，避免不必要的複製
- **相容性風險**: 可能與現有第三方庫衝突
  - **緩解**: 提供向後相容的轉換函數
- **程式碼複雜度**: 增加錯誤處理的複雜度
  - **緩解**: 保持 API 簡潔，提供輔助函數

## Migration Plan

### 階段 1: 基礎設施 (1-2 週)
1. 實現核心 Result 類型
2. 建立錯誤類型層次結構
3. 創建基礎工具函數
4. 編寫單元測試

### 階段 2: 服務層遷移 (2-3 週)
1. 遷移資料庫 gateway 層
2. 遷移業務邏輯服務
3. 更新 DI 容器註冊
4. 編寫集成測試

### 階段 3: 指令層遷移 (2-3 週)
1. 遷移斜線指令處理器
2. 更新錯誤回應邏輯
3. 提供向後相容工具
4. 編寫端到端測試

### 階段 4: 優化和監控 (1 週)
1. 效能優化
2. 監控集成
3. 文件更新
4. 團隊培訓

## Open Questions

- 是否需要支援部分錯誤恢復機制？
- 如何處理 Discord API 限流的 Result 模式？
- 是否需要實現 Result 的序列化/反序列化？
- 如何與現有的重試機制 (tenacity) 集成？
