## Context
DRoASMS是一個Discord經濟治理機器人項目，當前測試覆蓋率為47.4%，接近但不達到50%的目標。治理模組包含複雜的議會管理、國務院運作等邏輯，這些模組在處理大量數據和頻繁查詢時面臨性能挑戰。

## Constraints
- **向後兼容性**：mypyc編譯不能破壞現有API接口
- **漸進式導入**：不能一次性編譯所有模組，需要逐步驗證
- **測試完整性**：新測試必須真正提升覆蓋率，而非僅為形式
- **性能可測量**：需要量化mypyc的性能提升效果

## Goals / Non-Goals
- Goals:
  - 將整體測試覆蓋率提升到至少50%
  - 為治理模組引入mypyc編譯，獲得5-10倍性能提升
  - 建立性能回歸測試機制
  - 確保mypyc編譯不影響開發體驗

- Non-Goals:
  - 不是所有模組都需要mypyc編譯（僅限治理模組）
  - 不是追求100%測試覆蓋率（目標是50%）
  - 不是重寫現有邏輯（僅添加編譯層）

## Decisions

### Decision 1: Mypc目標模組選擇
**決策**：僅對治理相關模組應用mypyc編譯，包括：
- `src/db/gateway/council_governance.py`
- `src/db/gateway/state_council_governance.py`
- `src/db/gateway/supreme_assembly_governance.py`
- `src/bot/services/state_council_service.py`
- `src/bot/services/supreme_assembly_service.py`

**理由**：這些模組包含複雜的數據庫查詢和業務邏輯，性能瓶頸最明顯，且相對獨立，不影響核心經濟功能。

**替代方案考慮**：
- 編譯所有模組：風險太高，可能破壞穩定性
- 僅編譯數據網關層：效果有限，業務層瓶頸仍然存在
- 僅編譯服務層：無法解決數據庫查詢性能問題

### Decision 2: 測試覆蓋率重點區域
**決策**：專注於覆蓋率最低且最關鍵的模組：
- `supreme_assembly.py` (0% → 目標80%)
- `council.py` (13% → 目標70%)
- `state_council.py` (23% → 目標60%)
- `telemetry_listener.py` (30% → 目標60%)

**理由**：這些模組治理核心功能，且當前覆蓋率嚴重不足，投入測試資源效果最明顯。

**替代方案考慮**：
- 平均提升所有模組：資源分散，效果不明顯
- 僅添加測試不提升覆蓋率：無法達成50%目標

### Decision 3: Mypc編譯集成策略
**決策**：採用可選編譯模式，開發環境正常運行，生產環境啟用mypyc編譯。

**理由**：保持開發體驗，避免編譯時間影響開發效率，同時在生產環境獲得性能優勢。

**替代方案考慮**：
- 強制所有環境編譯：開發效率下降
- 僅CI環境編譯：無法驗證生產效果

## Risks / Trade-offs

### 風險1：Mypc編譯兼容性問題
- **風險**：某些Python特性在mypyc中不支持
- **緩解**：預先測試編譯，逐步擴大範圍，保留純Python版本作為後備

### 風險2：測試覆蓋率虛高
- **風險**：測試數量增加但質量不足
- **緩解**：專注關鍵路徑測試，添加性能和集成測試驗證

### 風險3：性能回歸
- **風險**：mypc編譯在某些場景可能降低性能
- **緩解**：建立性能基準測試，對比編譯前後性能

### Trade-off：開發複雜度 vs 性能收益
- **選擇**：接受適度的複雜度增加（編譯配置）以獲得顯著性能提升
- **平衡**：通過自動化和文檔降低複雜度影響

## Migration Plan

### 階段1：測試基礎增強（1-2週）
1. 添加性能基準測試框架
2. 為低覆蓋率模組添加關鍵單元測試
3. 驗證測試覆蓋率提升效果

### 階段2：Mypc試點（2-3週）
1. 為council_governance.py添加mypc編譯支持
2. 建立編譯和測試流程
3. 驗證性能提升和兼容性

### 階段3：規模擴展（2-3週）
1. 擴展到其他治理模組
2. 完善測試覆蓋率到50%+
3. 建立CI/CD集成

### 階段4：生產驗證（1週）
1. 生產環境灰度部署
2. 性能監控和回歸測試
3. 文檔更新和培訓

## Open Questions
1. 如何平衡mypc編譯時間和部署效率？
2. 測試覆蓋率50%是否足夠，是否需要更遠大的目標？
3. 如何監控和測量mypc在生產環境的實際性能提升？
4. 是否需要為其他模組預留mypc擴展能力？
