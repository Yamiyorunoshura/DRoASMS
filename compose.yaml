services:
  postgres:
    build:
      context: ./docker
      dockerfile: postgres.Dockerfile
    environment:
      POSTGRES_USER: bot
      POSTGRES_PASSWORD: bot
      POSTGRES_DB: economy
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./docker/init:/docker-entrypoint-initdb.d:ro
    # 啟用 pg_cron 所需的 shared_preload_libraries 與 cron.database_name
    command: [ "postgres", "-c", "shared_preload_libraries=pg_cron", "-c", "cron.database_name=economy" ]
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U bot -d economy" ]
      interval: 5s
      timeout: 5s
      retries: 30

  bot:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: production
      # 如需在 Apple Silicon 上建 linux/amd64 供 VPS 使用，取消下一行註解：
      # platforms: ["linux/amd64"]
      # 或在服務層級指定平台（較直覺）：
      # platform: linux/amd64
    env_file:
      - .env
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://bot:bot@postgres:5432/economy}
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    profiles: [ "prod" ]

  bot-dev:
    build:
      context: .
      dockerfile: docker/Dockerfile.dev
    env_file:
      - .env
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://bot:bot@postgres:5432/economy}
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      # Mount source code for live updates in development
      - ./src:/app/src
      - ./scripts:/app/scripts
      - ./tests:/app/tests
    profiles: [ "dev" ]

  pgadmin:
    profiles: [ "dev" ]
    image: dpage/pgadmin4:8
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@example.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-admin}
    depends_on:
      postgres:
        condition: service_healthy
    # 預設不啟用（需指定 --profile dev）。若要在本機存取，設定 .env 中 PGADMIN_PORT，或使用預設 8081：
    ports:
      - "127.0.0.1:${PGADMIN_PORT:-8081}:80"
    volumes:
      - pgadmin:/var/lib/pgadmin

  test:
    profiles: [ "test" ]
    build:
      context: .
      dockerfile: docker/test.Dockerfile
    # 以 root 身分執行測試容器，避免無法寫入掛載的 htmlcov 目錄導致 pytest-cov 在收斂覆蓋率時卡住
    # 若需降低權限，可改為在本機將 htmlcov 設為可寫（例如 chmod 777 htmlcov），或在未掛載時改用 /tmp
    user: "0:0"
    env_file:
      - .env
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://bot:bot@postgres:5432/economy}
      # 測試環境專用變數：依照 test-infrastructure 規格預設啟用整合與 Docker 測試
      RUN_DISCORD_INTEGRATION_TESTS: ${RUN_DISCORD_INTEGRATION_TESTS:-1}
      RUN_DOCKER_TESTS: ${RUN_DOCKER_TESTS:-1}
      TEST_MIGRATION_DB_URL: ${TEST_MIGRATION_DB_URL:-postgresql://bot:bot@postgres:5432/economy}
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      # 掛載測試目錄以便開發時即時更新
      - ./tests:/app/tests:ro
      - ./src:/app/src:ro
      - ./scripts:/app/scripts:ro
      # 供整合測試呼叫入口腳本（tests 會從 /app/docker/bin/entrypoint.sh 執行）
      - ./docker/bin:/app/docker/bin:ro
      - ./specs:/app/specs:ro
      - ./.env.example:/app/.env.example:ro
      # 掛載覆蓋率報告目錄
      - ./htmlcov:/app/htmlcov
      # 供整合測試在容器內執行 Docker / Docker Compose 指令
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /app

volumes:
  pgdata: {}
  pgadmin: {}
