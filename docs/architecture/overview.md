# DRoASMS 架構概述

## 專案簡介

DRoASMS（Discord Role-based Automated Society Management System）是一個以 Python 打造的 Discord 機器人原型，專注於社群的經濟系統與治理流程。本專案提供完整的虛擬貨幣系統、分級權限控制、以及多層級治理機制，適用於需要模擬經濟與治理結構的 Discord 社群。

## 整體架構

```
┌─────────────────────────────────────────────────────────┐
│                    Discord 介面層                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │ Slash命令   │  │ 按鈕交互    │  │ 模態對話框  │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────┘
                               │
┌─────────────────────────────────────────────────────────┐
│                    命令分發層                             │
│  ┌─────────────────────────────────────────────────┐    │
│  │             命令處理器與路由邏輯                   │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
                               │
┌─────────────────────────────────────────────────────────┐
│                    業務邏輯層                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │ 經濟系統服務 │  │ 治理系統服務 │  │ 配置管理服務 │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────┘
                               │
┌─────────────────────────────────────────────────────────┐
│                    資料存取層                             │
│  ┌─────────────────────────────────────────────────┐    │
│  │           資料庫閘道層 (Gateway Pattern)          │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
                               │
┌─────────────────────────────────────────────────────────┐
│                    持久化層                               │
│  ┌─────────────────────────────────────────────────┐    │
│  │               PostgreSQL 資料庫                   │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
```

## 核心模組說明

### 1. 經濟系統模組
負責虛擬貨幣的發行、轉移、餘額管理與交易記錄。

- **餘額服務** (`BalanceService`): 查詢用戶餘額與帳戶狀態
- **轉帳服務** (`TransferService`): 處理用戶間的點數轉移
- **調整服務** (`AdjustmentService`): 管理員調整用戶點數
- **轉帳事件池** (`TransferEventPool`): 異步轉帳處理與重試機制
- **貨幣配置服務** (`CurrencyConfigService`): 管理伺服器貨幣設定

### 2. 治理系統模組
提供多層級的社群治理機制，支援提案、投票與決策執行。

- **常任理事會** (`CouncilService`): 基於角色的提案投票系統
- **國務院治理** (`StateCouncilService`): 部門為單位的治理系統
- **最高人民會議** (`SupremeAssemblyService`): 最高層級的治理機制
- **司法治理** (`JusticeGovernance`): 司法相關功能與爭議解決

### 3. 資料存取層
採用閘道模式 (Gateway Pattern) 封裝資料庫操作，提供清晰的資料存取介面。

- **經濟系統閘道**: `economy_queries`, `economy_transfers`, `economy_adjustments`
- **治理系統閘道**: `council_governance`, `state_council_governance`
- **配置閘道**: `economy_configuration`, `pending_transfers`

### 4. 基礎設施層
提供共享的技術基礎設施，支援可維護性與可測試性。

- **依賴注入容器**: 統一管理服務依賴關係
- **結果模式** (Result Pattern): 標準化的錯誤處理機制
- **事件系統**: 事件驅動架構支援鬆耦合模組通訊
- **遙測監控**: 系統運行時監控與日誌記錄

### 5. 性能優化層
透過 Cython 編譯核心模組，顯著提升運行時性能。

- **Cython 編譯模塊**: 位於 `src/cython_ext/` 目錄
- **統一編譯器**: 自動化的編譯管線與性能測試
- **增量編譯**: 支援模塊級別的增量編譯

## 資料流程

### 轉帳流程示例
```
用戶發起轉帳請求
    ↓
轉帳服務驗證（餘額、限流、冷卻）
    ↓
轉帳事件池（異步處理，支援重試）
    ↓
資料庫閘道執行事務操作
    ↓
更新餘額並記錄交易歷史
    ↓
返回結果給用戶
```

### 治理提案流程
```
理事發起轉帳提案
    ↓
鎖定當前理事名冊快照
    ↓
向所有理事發送投票請求（DM）
    ↓
收集投票並計算結果
    ↓
達到門檻後執行轉帳
    ↓
記錄提案結果與執行狀態
```

## 技術棧

### 後端技術
- **程式語言**: Python 3.13
- **Web 框架**: Discord.py (Discord API 客戶端)
- **資料庫**: PostgreSQL 15+ (支援 ACID 事務)
- **ORM/資料庫層**: asyncpg (非同步 PostgreSQL 驅動)
- **依賴管理**: uv (現代 Python 套件管理器)
- **配置管理**: Pydantic v2 (類型安全的設定驗證)

### 開發工具
- **測試框架**: pytest + pytest-asyncio
- **類型檢查**: MyPy + Pyright (雙重檢查策略)
- **程式碼格式化**: Black + Ruff
- **性能優化**: Cython (靜態編譯)
- **容器化**: Docker + Docker Compose
- **持續整合**: GitHub Actions

### 資料庫擴展
- **pgcrypto**: 加密功能與 UUID 生成
- **pg_cron**: 自動化任務排程（交易記錄歸檔）

## 設計模式與架構原則

### 採用的設計模式
1. **依賴注入模式**: 透過 DI 容器管理服務依賴
2. **閘道模式**: 封裝資料庫操作，隔離業務邏輯與資料存取
3. **結果模式**: 統一錯誤處理，避免異常傳播
4. **事件驅動架構**: 鬆耦合模組通訊
5. **分層架構**: 清晰的職責分離（介面層、業務層、資料層）

### 架構原則
1. **單一職責原則**: 每個模組專注於單一功能領域
2. **開閉原則**: 透過擴展而非修改來增加新功能
3. **依賴倒置原則**: 高層模組不依賴低層模組實現細節
4. **測試驅動開發**: 嚴格的測試覆蓋確保程式碼品質
5. **性能優化**: 核心路徑使用 Cython 編譯提升性能

## 擴展性考量

### 水平擴展
- 無狀態的業務邏輯層可水平擴展
- 資料庫連線池管理支援高併發
- 事件驅動架構便於分散式部署

### 垂直擴展
- Cython 編譯優化 CPU 密集型操作
- 非同步 I/O 最大化單執行緒效能
- 資料庫索引與查詢優化

### 功能擴展
- 模組化設計便於新增治理機制
- 插件架構支援自定義經濟規則
- 可配置的權限系統適應不同社群需求

## 相關文件

- [安裝指南](../guides/installation.md)
- [API 參考](../api/overview.md)
- [開發者指南](../guides/development.md)
- [部署指南](../guides/deployment.md)
