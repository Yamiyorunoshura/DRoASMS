name: Tests (Matrix)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        envset: [min, latest]
    steps:
      - uses: actions/checkout@v4
      - name: Install UV
        run: |
          curl -Ls https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Select Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      - name: Resolve dependencies
        run: |
          if [ "${{ matrix.envset }}" = "min" ]; then
            uv lock --no-upgrade
          else
            uv lock --upgrade
          fi
      - name: Run unit/integration (mock) tests
        env:
          RUN_DISCORD_INTEGRATION_TESTS: '0'
        run: |
          uv run pytest -n auto -m 'unit or integration'
